<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tasks</title>
    <link href="https://cdn.datatables.net/v/bs4/dt-1.13.4/datatables.min.css"
          rel="stylesheet"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          rel="stylesheet">
</head>

<body style="background: rgba(47,20,96,0.51); padding-top: 10px; padding-left: 150px; padding-right: 10px" ;>
<div class="container">
    <table class="table table-border table-striped" id="tasks-table" style="width: 500px">
        <thead class="table-dark">
        <tr>
            <td style="width: 500px; font-size: x-large; padding-left: 300px">ToDos</td>
            <td style="width: 300px"></td>
        </tr>
        <tr>
            <form th:action="@{/save-task}" th:object="${task}" method="POST">
                <td><input type="text" th:field="*{title}" placeholder="Enter todo here" class="form-control-sm-200"
                           style="width: 500px">
                <td>
                    <button class="btn btn-light" type="submit">Submit</button>
                </td>
            </form>
        </tr>
        </thead>
        <tbody>
        <tr th:each="task : ${tasks}">
            <td>
                <input type="checkbox" th:checked="${task.completed}" th:attr="data-task-id=${task.id}"
                       onchange="changeStatus(this)">
                <span th:text="${task.title}" th:attr="data-task-id=${task.id}" class="task-name"></span>
                <i class="fas fa-pencil edit-icon" style="padding-inline-end: 100px" onclick="enableEdit(this)"></i>
            </td>
            <td>
                <a th:href="@{/delete-task(taskId=${task.id})}" class="btn btn-warning"
                >Del</a>
            </td>
        </tr>
        </tbody>
    </table>

    <a th:href="@{/}" style="position: fixed; left:300px; bottom: 40px;">Вернуться</a>

</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.datatables.net/v/bs4/jq-3.6.0/dt-1.13.4/datatables.min.js"></script>

<script>
    //method for change status in checkbox
    function changeStatus(checkbox) {
        let taskId = checkbox.getAttribute("data-task-id");
        console.log(taskId);
        let completed = checkbox.checked;
        let data = {
            id: taskId,
            completed: completed };

        let xhr = new XMLHttpRequest();
        xhr.open("POST", "update-status", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                console.log("Статус задачи изменен!");
            } else {
                console.error("Ошибка при изменении статуса задачи");
            }
        };
        xhr.send(JSON.stringify(data));
    }


    // method for change title of task. app will save changes on click "Enter"
    function enableEdit(editIcon) {
        let taskNameElement = editIcon.previousElementSibling;
        taskNameElement.contentEditable = true;
        taskNameElement.focus();
        taskNameElement.classList.add("editable");
        taskNameElement.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                saveTitle(taskNameElement);
            }
        });
    }
    // method for save changes in title
    function saveTitle(taskNameElement) {
        taskNameElement.contentEditable = false;
        taskNameElement.classList.remove("editable");
        let taskId = taskNameElement.getAttribute("data-task-id");
        let newTaskName = taskNameElement.textContent;

        let data = {
            id: taskId,
            title: newTaskName };
        let xhr = new XMLHttpRequest();
        xhr.open("POST", "/update-task", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                console.log("Изменения сохранены!");
            } else {
                console.error("Ошибка при сохранении изменений"); } };
        xhr.send(JSON.stringify(data));
    }

</script>
</body>
</html>